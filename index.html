<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV频道中文翻译工具（15秒自动更新+Gitee同步）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Consolas, sans-serif; }
        body { background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 3px 12px rgba(0,0,0,0.1); padding: 25px; }
        h1 { text-align: center; color: #2d3748; margin-bottom: 20px; font-size: 22px; }
        .control-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 24px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
        .start-btn { background: #2563eb; color: white; display: none; }
        .stop-btn { background: #ef4444; color: white; }
        .stop-btn:hover { background: #dc2626; }
        .refresh-now-btn { background: #f59e0b; color: white; }
        .refresh-now-btn:hover { background: #d97706; }
        .status { text-align: center; margin-bottom: 15px; font-size: 15px; color: #475569; }
        .status.success { color: #10b981; }
        .status.error { color: #ef4444; }
        .status.running { color: #2563eb; }
        textarea { width: 100%; height: 350px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 6px; resize: vertical; font-size: 14px; line-height: 1.5; background: #f8fafc; }
        .download-btn { display: block; margin: 15px auto 0; padding: 9px 24px; font-size: 15px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
        .download-btn:hover { background: #059669; }
        .download-btn.hidden { display: none; }
        .timer { text-align: center; margin-top: 10px; font-size: 13px; color: #64748b; }
        .gitee-link { text-align: center; margin-top: 10px; font-size: 13px; color: #2563eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>94 TV频道中文翻译工具（15秒自动更新+Gitee同步）</h1>
        
        <div class="control-group">
            <button class="btn start-btn" id="startBtn" onclick="startAutoRefresh()">7415 启动自动更新</button>
            <button class="btn stop-btn" id="stopBtn" onclick="stopAutoRefresh()">7315 停止自动更新</button>
            <button class="btn refresh-now-btn" id="refreshNowBtn" onclick="extractAndTranslate()">94 立即刷新</button>
        </div>

        <div class="status" id="status">94 页面加载中，自动启动15秒更新+Gitee同步...</div>
        <div class="timer" id="timer">下次自动更新：15秒</div>

        <textarea id="resultText" placeholder="翻译后的标准化频道文本将显示在这里..." readonly></textarea>
        
        <button class="download-btn hidden" id="downloadBtn" onclick="downloadTXT()">93 本地下载中文翻译版TXT</button>
        
        <div class="gitee-link">Gitee固定TXT地址：<a href="https://gitee.com/jasongero/migu/raw/master/tv_channels_chinese.txt" target="_blank">https://gitee.com/jasongero/migu/raw/master/tv_channels_chinese.txt</a></div>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const refreshNowBtn = document.getElementById('refreshNowBtn');
        const statusElem = document.getElementById('status');
        const timerElem = document.getElementById('timer');
        const resultTextElem = document.getElementById('resultText');
        const downloadBtn = document.getElementById('downloadBtn');
        
        let translatedText = '';
        let autoRefreshTimer = null;
        const REFRESH_INTERVAL = 15000; // 15秒更新一次

        // 已填入你的Gitee真实参数（branch已改为master，无需修改）
        const GITEE_CONFIG = {
            token: '2087d982f4eb7f94ae412bda22b30e94', // 你的私人令牌（已填入）
            user: 'jasongero', // 你的Gitee用户名
            repo: 'migu', // 你的仓库名
            filePath: 'tv_channels_chinese.txt', // 固定TXT文件名
            branch: 'master' // 已改为master分支（关键修改）
        };

        // 核心频道名称翻译词典
        const channelTransDict = {
            // 新闻类
            'CNN': '美国有线电视新闻网',
            'BBC News': '英国广播公司新闻台',
            'Fox News': '福克斯新闻台',
            'CNBC': '消费者新闻与商业频道',
            'Al Jazeera': '半岛电视台',
            'RT News': '今日俄罗斯新闻台',
            'Euronews': '欧洲新闻台',
            'France 24': '法国24小时新闻台',
            'Deutsche Welle': '德国之声',
            'NHK World TV': '日本NHK世界电视台',
            // 体育类
            'ESPN': '娱乐与体育节目电视网',
            'Fox Sports': '福克斯体育台',
            'Sky Sports': '天空体育台',
            'beIN Sports': '拜因体育台',
            'SportTV': '体育电视台',
            'Eurosport': '欧洲体育台',
            'NBC Sports': '全国广播公司体育台',
            'CBS Sports': '哥伦比亚广播公司体育台',
            'Star Sports': '星空体育台',
            'DAZN': '达赞体育流媒体',
            // 影视类
            'HBO': '家庭影院频道',
            'Netflix': '网飞',
            'Disney Channel': '迪士尼频道',
            'Cartoon Network': '卡通网络频道',
            'Nickelodeon': '尼克儿童频道',
            'Discovery Channel': '探索频道',
            'National Geographic': '国家地理频道',
            'History Channel': '历史频道',
            'TNT': '特纳电视网',
            'AMC': '美国经典电影频道',
            // 综合类
            'BBC': '英国广播公司',
            'ABC': '美国广播公司',
            'NBC': '全国广播公司',
            'CBS': '哥伦比亚广播公司',
            'Fox': '福克斯广播公司',
            'ITV': '独立电视台',
            'France 2': '法国2台',
            'ARD': '德国公共广播联盟',
            'ZDF': '德国电视二台',
            'RAI': '意大利广播电视公司',
            // 中文频道
            'CCTV': '中国中央电视台',
            '凤凰卫视': '凤凰卫视',
            'TVBS': '无线卫星电视台',
            '中天电视': '中天电视',
            // 其他常见
            'MTV': '音乐电视网',
            'Bloomberg': '彭博财经台',
            'Animal Planet': '动物星球频道',
            'Food Network': '美食频道',
            // 语言标识翻译
            'English': '英语',
            'Espa09ol': '西班牙语',
            'Fran04ais': '法语',
            'Deutsch': '德语',
            'Русский': '俄语',
            '日本Z': '日语',
            '637025': '韩语',
            '中文': '中文'
        };

        // 页面加载自动启动更新
        window.onload = () => {
            startAutoRefresh();
        };

        // 启动自动更新
        function startAutoRefresh() {
            if (autoRefreshTimer) return;
            stopBtn.disabled = false;
            statusElem.textContent = '94 自动更新已启动（每15秒一次）+ Gitee同步中...';
            statusElem.className = 'status running';
            extractAndTranslate();
            autoRefreshTimer = setInterval(extractAndTranslate, REFRESH_INTERVAL);
            updateTimerDisplay();
        }

        // 停止自动更新
        function stopAutoRefresh() {
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
            statusElem.textContent = '7315 自动更新已停止，可点击「立即刷新」手动获取';
            statusElem.className = 'status';
            timerElem.textContent = '下次自动更新：--';
        }

        // 倒计时显示
        function updateTimerDisplay() {
            if (!autoRefreshTimer) return;
            let countdown = REFRESH_INTERVAL / 1000;
            timerElem.textContent = `下次自动更新：${countdown}秒`;
            const countdownTimer = setInterval(() => {
                countdown--;
                timerElem.textContent = `下次自动更新：${countdown}秒`;
                if (countdown <= 0 || !autoRefreshTimer) clearInterval(countdownTimer);
            }, 1000);
        }

        // 核心：提取+翻译+整理+Gitee同步
        async function extractAndTranslate() {
            try {
                statusElem.textContent = '94 正在获取并更新频道数据...';
                statusElem.className = 'status running';
                refreshNowBtn.disabled = true;

                // 抓取原始数据
                const response = await fetch('https://freetv.fun/test_channels_original_new.txt');
                if (!response.ok) throw new Error(`请求失败：${response.status}`);
                const rawText = await response.text();

                // 整理+翻译+去分辨率标识
                translatedText = formatTranslateAndClean(rawText);
                resultTextElem.value = translatedText;
                downloadBtn.classList.remove('hidden');

                // 同步到你的Gitee仓库（master分支）
                await pushToGitee(translatedText);

                statusElem.textContent = `73 频道更新+Gitee同步完成（${new Date().toLocaleTimeString()}）`;
                statusElem.className = 'status success';
                updateTimerDisplay();

            } catch (error) {
                statusElem.textContent = `74 更新失败：${error.message}`;
                statusElem.className = 'status error';
                resultTextElem.value = `错误详情：${error.message}\n解决方法：1. 检查网络 2. 安装Chrome+CORS插件 3. 确认Gitee令牌权限`;
            } finally {
                refreshNowBtn.disabled = false;
            }
        }

        // 格式整理+翻译+去分辨率
        function formatTranslateAndClean(rawText) {
            const lines = rawText.split('\n');
            const result = [];
            let currentCountry = '';

            lines.forEach(line => {
                const trimLine = line.trim();
                if (trimLine === '' || trimLine.startsWith('#')) return;

                // 国家行（保留格式：国家,#genre#）
                if (trimLine.includes('#genre#') && !trimLine.includes('https://') && !trimLine.includes('rtmp://')) {
                    currentCountry = trimLine.replace(',#genre#', '');
                    result.push(`${currentCountry},#genre#`);
                } 
                // 频道行（翻译名称+去分辨率+保留格式：中文名称,地址）
                else if (trimLine.includes(',https://') || trimLine.includes(',rtmp://')) {
                    if (currentCountry) {
                        const [channelName, url] = trimLine.split(',');
                        if (channelName && url) {
                            const cleanName = channelName.replace(/\[(HD|SD|VGA|BD|4K|UHD|QHD)\]/gi, '').trim();
                            const translatedName = translateChannelName(cleanName);
                            result.push(`${translatedName},${url.trim()}`);
                        }
                    }
                }
            });

            // 去重并返回
            return [...new Set(result)].join('\n');
        }

        // 频道名翻译
        function translateChannelName(name) {
            let translated = name;
            Object.entries(channelTransDict).forEach(([en, cn]) => {
                translated = translated.replace(new RegExp(en, 'gi'), cn);
            });
            return translated;
        }

        // 同步数据到Gitee master分支（已适配）
        async function pushToGitee(data) {
            try {
                // 1. 获取文件当前SHA（Gitee更新必需）
                const getShaRes = await fetch(
                    `https://gitee.com/api/v5/repos/${GITEE_CONFIG.user}/${GITEE_CONFIG.repo}/contents/${GITEE_CONFIG.filePath}`,
                    { headers: { Authorization: `token ${GITEE_CONFIG.token}` } }
                );
                const shaData = await getShaRes.json();
                const fileSha = shaData.sha || ''; // 首次创建时SHA为空，Gitee会自动创建

                // 2. 上传更新数据（Base64编码避免乱码）
                const pushRes = await fetch(
                    `https://gitee.com/api/v5/repos/${GITEE_CONFIG.user}/${GITEE_CONFIG.repo}/contents/${GITEE_CONFIG.filePath}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `token ${GITEE_CONFIG.token}`
                        },
                        body: JSON.stringify({
                            content: btoa(unescape(encodeURIComponent(data))),
                            message: `自动更新频道列表：${new Date().toLocaleString()}`,
                            sha: fileSha,
                            branch: GITEE_CONFIG.branch
                        })
                    }
                );

                if (!pushRes.ok) {
                    const errData = await pushRes.json();
                    throw new Error(errData.message || 'Gitee接口请求失败');
                }
            } catch (err) {
                console.error('Gitee同步出错：', err);
                throw new Error(`Gitee同步失败：${err.message}`);
            }
        }

        // 本地下载TXT
        function downloadTXT() {
            if (!translatedText) return;
            const blob = new Blob([translatedText], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TV频道_中文翻译版_${new Date().toLocaleDateString()}_${new Date().toLocaleTimeString().replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            statusElem.textContent = `73 本地下载成功！文件已保存（${new Date().toLocaleTimeString()}）`;
        }

        // 页面卸载时清除定时器，避免内存泄漏
        window.onbeforeunload = () => {
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
        };
    </script>
</body>
</html>
